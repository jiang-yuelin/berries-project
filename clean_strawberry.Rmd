---
title: "clean_strawberry"
author: "Yuelin Jiang"
date: "10/18/2020"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(knitr)
library(tidyverse)
library(magrittr)
library(kableExtra)
library(stringr)
library(ggplot2)

opts_chunk$set(echo = FALSE, 
               warning = FALSE,
               message = FALSE)

knitr::opts_chunk$set(echo = TRUE)
```

##  Acquire and read the data

These data were collected from the USDA database selector: <a href="https://quickstats.nass.usda.gov">https://quickstats.nass.usda.gov</a>

The data were <a href="https://quickstats.nass.usda.gov/results/D416E96E-3D5C-324C-9334-1D38DF88FFF1">stored online</a> and then downloaded as a CSV file.

```{r}
## read the data

ag_data <- read_csv("berries.csv", col_names = TRUE)

## look at number of unique values in each column
ag_data %>% summarize_all(n_distinct) -> aa


## make a list of the columns with only one unique value
bb <- which(aa[1,]==1)

## list the 1-unique valu column names 
cn <- colnames(ag_data)[bb]
cn
```

Data selected from the NASS database often has columns without any data or with a single repeated Values.  The berries data had only 8 out of 21 columns containing meaningful data. These first steps of cleaning codes are recycled from Haviland's code in ag_data.rmd

```{r}
## remove the 1-unique columns from the dataset
ag_data %<>% select(-all_of(bb))

aa %<>% select(-all_of(bb)) 


## State name and the State ANSI code are (sort of) redundant
## Just keep the name
ag_data %<>% select(-4)
aa %<>% select(-4) 


kable(head(ag_data)) %>% kable_styling(font_size=12)
```
## Data Cleaning
Only selet strawberries as our commodity for EDA, and only select when period equals year.


```{r}
sberry <- ag_data %>% filter((Commodity=="STRAWBERRIES") & (Period=="YEAR"))
sberry %<>% select(-c(Commodity, Period))

# Does every Data Item begin with "STRAWBERRIES"
sum(str_detect(sberry$`Data Item`, "^STRAWBERRIES")) == length(sberry$`Data Item`)

# Remove "STRAWBERRIES" in the begginning of the Data Item column, drop this column
sberry %<>% separate(`Data Item`, c('straw', 'data_item'), sep = nchar("STRAWBERRIES")+2)
sberry %<>% select(-c(straw))

sberry %<>% separate(data_item, c('what', 'measure', 'how'), sep = ",")
sberry$what %>% unique()

# Notice when 'what' == 'PROCESSING', content of measure is in 'how' column. Switch the content
sberry %<>% mutate(measure = ifelse(what == "PROCESSING", how, measure))
sberry %<>% mutate(how = ifelse(what == "PROCESSING", "", how))

# Repeat the above process for 'what' == 'FRESH MARKET'
sberry %<>% mutate(what = ifelse(what == "FRESH MARKET", "FRESH MARKET - UTILIZED - PRODUCTION", what))
sberry %<>% mutate(measure = ifelse(what == "FRESH MARKET - UTILIZED - PRODUCTION", how, measure))
sberry %<>% mutate(how = ifelse(what == "FRESH MARKET - UTILIZED - PRODUCTION", "", how))

# 

sberry$unit <- ""
sberry %<>% mutate(unit = ifelse(str_detect(sberry$measure, "^ MEASURED IN "), substr(sberry$measure, nchar(" MEASURED IN ")+1, nchar(sberry$measure)))) 
                 
# sberry$unit %>% unique()     
# sberry$how %>% unique()

sberry %<>% select(-c(how, measure))
```

Now work on separating the 'Domain' and 'Domain Category' columns into meaningful columns.

```{r}


sberry$Domain %>% unique()
# Separate the Domain column by ","
sberry %<>% separate(Domain, c('domain1', 'domain2'), sep = ",")


sberry$`Domain Category` %>% unique()
# separate Domain Category by ","

sberry %<>% separate(`Domain Category`, c('dc1', 'dc2', 'dc_detail'), sep = "[,\\:]", convert = TRUE, extra = "merge")

sberry$dc1 %>% unique()

# Manually fix for type [4]
# sberry %<>% mutate(dc2 = ifelse(dc1 == "CHEMICAL, INSECTICIDE: (CYFLUMETOFENï¿½= 138831)
# ", "INSECTICIDE", dc2))
# sberry %<>% mutate(dc_detail = ifelse(dc1 == "CHEMICAL, INSECTICIDE: (CYFLUMETOFEN\xa0= 138831)", "(CYFLUMETOFEN = 138831)", dc_detail))
# sberry %<>% mutate(dc1 = ifelse(dc1 == "CHEMICAL, INSECTICIDE: (CYFLUMETOFEN\xa0= 138831)", "CHEMICAL", dc1))

sberry[is.na(sberry)] <- " "
sberry$dc1 %>% unique()

```

```{r}
write.csv(sberry, "sberry_cleaned.csv")
num<- sberry
num$Value <- gsub(pattern = ",", replacement = "", sberry$Value)
num$Value <- as.numeric(num$Value)/1000000
```

## Exploratory Data Analysis

### Total Production Data for each state across the years
```{r}
d_total <- subset(sberry, domain1 == "TOTAL")

# Subset where unit is in $
usd <- subset(d_total, unit == "$")
test <- usd

# Set value to numeric
usd$Value <- as.numeric(gsub(pattern = ",", replacement = "",usd$Value))
usd[is.na(usd)] <- 0

# Prepare dataset of production for plots
prod <- subset(usd, what == " PRODUCTION" )

# Plot production by each state
par(mfrow = c(3,4))
state_list <- d_total$State %>% unique()

for (i in state_list) {
  stateTotal <- subset(prod, State == i)
  plot(x =stateTotal$Year, y = stateTotal$Value/1000000, xlab="Year", ylab=paste(i),
       title(main = "Production in millions $"), pch =16, ylim =c(0, 2900), xlim = c(2015, 2019))
}

```

### Relationship between amount of fertilizers and yield per acre.

```{r}
#, warning=FALSE, message=FALSE
# Prepare database for yield
yield <- subset(d_total, what == " YIELD" )


# # Make values numeric
# yield %<>% mutate(Value = ifelse(Value=="(NA)", "0", Value) )
# yield$Value %<>% as.numeric(yield$Value)  
# # class(yield$Value)

# Prepare database for fertilizer used, unit LB/ARE/YEAR
fert <- subset(sberry, domain1 =="FERTILIZER" & unit == "LB / ACRE / YEAR")

# Since fertilizer data only exists for california and florida in year 2018 and 2019, 
yield <- subset(d_total, what == " YIELD" & (State == "CALIFORNIA" | State== "FLORIDA")& (Year=="2019" |Year=="2018") ) 

fert %<>% fill()


fert$yield <- NA
statelist<- fert%>% unique()

fert$Value<- as.numeric(fert$Value)
fert[is.na(fert)] <- 0

for (i in 1:15) {
  if (fert$Year[i]=="2018"){
    if(fert$State[i]=="CALIFORNIA"){
      fert$yield[i] <- 660
    } else {
      fert$yield[i] <- 250
    }
  } else {
    if(fert$State[i]=="CALIFORNIA"){
      fert$yield[i] <- 580
    } else{
      fert$yield[i] <- 215
    }
  }
}


ggplot(data = fert)+
  geom_point(aes(x= Value, y= yield,  color = factor(State)) )+
  ylab("Strawberry Yield (CWT/ACRE)")+
  xlab("Fertilizer applied (LB /ACRE /Year)")
  # title(main = "Strawberry yield as a function of fertilizers")


```


### Chemicals used

```{r}
# Dataframe of total amount of chemicals used

chemi <- subset(sberry, dc_detail ==" (TOTAL)" & unit == "LB")

chemi$Value <-as.numeric(gsub(pattern = ",", replacement = "",chemi$Value)) 
class(chemi$Value)

chemi[is.na(chemi)] <- 0
chemi$State %>% unique()
```


```{r}

```


